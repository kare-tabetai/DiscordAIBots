# セットアップ手順

Discord画像評価Botを動作させるための設定手順を説明します。

## 前提条件

- Python 3.11以上
- Ollama（ローカルにインストール済み）
- Google Cloud Platformアカウント
- Discord Developer Portalアカウント

---

## 1. Ollamaのセットアップ

### 1.1 Ollamaのインストール

公式サイトからOllamaをインストール: https://ollama.com/

### 1.2 minicpm-vモデルのダウンロード

```bash
ollama pull minicpm-v
```

### 1.3 動作確認

```bash
ollama run minicpm-v
```

プロンプトが表示されれば正常にインストールされています。

---

## 2. Google Cloud設定

### 2.1 プロジェクト作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを使用）

### 2.2 Google Drive APIの有効化

1. 「APIとサービス」→「ライブラリ」
2. 「Google Drive API」を検索
3. 「有効にする」をクリック

### 2.3 サービスアカウントの作成

1. 「APIとサービス」→「認証情報」
2. 「認証情報を作成」→「サービスアカウント」
3. サービスアカウント名を入力（例: `discord-bot`）
4. 「作成して続行」をクリック
5. ロールは不要（スキップ可能）
6. 「完了」をクリック

### 2.4 認証キーのダウンロード

1. 作成したサービスアカウントをクリック
2. 「キー」タブを開く
3. 「鍵を追加」→「新しい鍵を作成」
4. 「JSON」を選択して「作成」
5. ダウンロードされたJSONファイルを `credentials.json` としてプロジェクトルートに配置

### 2.5 画像の共有設定

Google Drive上の画像をサービスアカウントと共有する必要があります：

1. 共有したい画像（またはフォルダ）を右クリック
2. 「共有」を選択
3. サービスアカウントのメールアドレスを追加
   - メールアドレスは `credentials.json` 内の `client_email` フィールドに記載
   - 例: `discord-bot@your-project.iam.gserviceaccount.com`
4. 「閲覧者」権限を付与

---

## 3. Discord Bot設定

### 3.1 Botアプリケーションの作成

1. [Discord Developer Portal](https://discord.com/developers/applications)にアクセス
2. 「New Application」をクリック
3. アプリケーション名を入力して作成

### 3.2 Botの設定

1. 左メニューの「Bot」を選択
2. 「Add Bot」をクリック
3. 「MESSAGE CONTENT INTENT」を有効化（必須）
4. 「Reset Token」でトークンを取得

### 3.3 Botの招待

1. 左メニューの「OAuth2」→「URL Generator」
2. SCOPES: `bot` を選択
3. BOT PERMISSIONS:
   - Read Messages/View Channels
   - Send Messages
   - Read Message History
4. 生成されたURLをブラウザで開いてサーバーに招待

---

## 4. 環境変数の設定

### 4.1 .envファイルの作成

```bash
cp .env.example .env
```

### 4.2 .envの編集

```
DISCORD_TOKEN=your_discord_bot_token_here
GOOGLE_CREDENTIALS_PATH=./credentials.json
OLLAMA_HOST=http://localhost:11434
OLLAMA_MODEL=minicpm-v
EVALUATION_PROMPT=この画像を評価し、内容の説明と改善点を日本語で回答してください。
```

---

## 5. 依存関係のインストール

```bash
# uvを使う場合（推奨）
uv venv
.venv\Scripts\activate  # Windows
uv pip install -e .

# pipを使う場合
python -m venv .venv
.venv\Scripts\activate  # Windows
pip install -e .
```

---

## 6. Botの起動

```bash
python -m src.main
```

正常に起動すると以下のようなログが表示されます：

```
2024-XX-XX XX:XX:XX [INFO] src.main: Configuration loaded successfully
2024-XX-XX XX:XX:XX [INFO] src.main: Starting Discord bot...
2024-XX-XX XX:XX:XX [INFO] src.bot: Logged in as BotName#1234 (ID: 123456789)
2024-XX-XX XX:XX:XX [INFO] src.bot: Using model: minicpm-v
```

---

## 7. 使い方

Discordサーバーで以下のようにメンションします：

```
@BotName https://drive.google.com/file/d/xxxxx/view
```

Botが画像を取得し、評価結果を返信します。

---

## トラブルシューティング

### Google Drive APIエラー

- サービスアカウントに画像が共有されているか確認
- `credentials.json` のパスが正しいか確認

### Ollamaエラー

- Ollamaが起動しているか確認: `ollama list`
- モデルがインストールされているか確認: `ollama pull minicpm-v`

### Discord接続エラー

- トークンが正しいか確認
- MESSAGE CONTENT INTENTが有効か確認
